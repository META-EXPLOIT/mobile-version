package br.com.metaexploit.diversight.ui.singup

import android.os.Bundle
import android.view.View
import android.widget.ImageView
import android.widget.Toast
import androidx.fragment.app.Fragment
import androidx.navigation.fragment.findNavController
import androidx.navigation.fragment.navArgs
import br.com.metaexploit.diversight.R
import br.com.metaexploit.diversight.remote.DiversightService
import br.com.metaexploit.diversight.remote.UserRegister
import com.google.android.material.button.MaterialButton
import com.google.android.material.textfield.TextInputLayout
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch

class SingUpPart4Fragment : Fragment(R.layout.fragment_sing_up_part4) {

    private val args: SingUpPart4FragmentArgs by navArgs()

    private lateinit var backButton: ImageView
    private lateinit var password: TextInputLayout
    private lateinit var passwordConfirm: TextInputLayout
    private lateinit var nextButton: MaterialButton

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
        super.onViewCreated(view, savedInstanceState)

        // Back button
        backButton = view.findViewById(R.id.fg_sing_up_4_button_back)
        backButton.setOnClickListener {
            findNavController().popBackStack()
        }

        password = view.findViewById(R.id.fg_sing_up4_edt_password)
        passwordConfirm = view.findViewById(R.id.fg_sing_up4_edt_password_confirm)

        // Next button
        nextButton = view.findViewById(R.id.fg_sing_up_4_user_btn_next)
        nextButton.setOnClickListener {
            if (password.editText?.text.toString() == passwordConfirm.editText?.text.toString()) {
                postUser()
            } else {
                Toast.makeText(context, "As senhas não conferem", Toast.LENGTH_SHORT).show()
            }
        }
    }

    private fun postUser() {
        CoroutineScope(Dispatchers.IO).launch {
            DiversightService.newInstance().register(
                UserRegister(
                    args.name,
                    args.skin,
                    args.sex,
                    args.gender,
                    args.birthday,
                    args.pcd,
                    args.pcdVisual,
                    args.pcdFisical,
                    args.pcdHearing,
                    args.pcdIntellectual,
                    args.pcdPsychosocial,
                    args.pcdReadapted,
                    args.enterprise,
                    args.occupation,
                    args.office,
                    args.email,
                    passwordConfirm.editText?.text.toString()
                )
            )

            CoroutineScope(Dispatchers.Main).launch {
                Toast.makeText(context, "Cadastro concluído!", Toast.LENGTH_SHORT).show()
                findNavController().navigate(R.id.loginFragment)
            }
        }
    }
}
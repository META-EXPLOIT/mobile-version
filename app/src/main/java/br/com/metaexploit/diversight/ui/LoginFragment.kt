package br.com.metaexploit.diversight.ui

import android.os.Build
import android.os.Bundle
import android.util.Log
import android.view.View
import androidx.appcompat.widget.AppCompatTextView
import androidx.core.content.res.ResourcesCompat
import androidx.fragment.app.Fragment
import androidx.navigation.fragment.findNavController
import br.com.metaexploit.diversight.R
import br.com.metaexploit.diversight.remote.DiversightService
import br.com.metaexploit.diversight.remote.LoginRequest
import br.com.metaexploit.diversight.remote.User
import com.google.android.material.button.MaterialButton
import com.google.android.material.textfield.TextInputEditText
import com.google.android.material.textfield.TextInputLayout
import kotlinx.coroutines.CoroutineName
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch
import retrofit2.Response

class LoginFragment : Fragment(R.layout.fragment_login) {

    private lateinit var singUp: AppCompatTextView
    private lateinit var login: MaterialButton

    private lateinit var emailView: TextInputLayout
    private lateinit var passwordView: TextInputLayout

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
        super.onViewCreated(view, savedInstanceState)

        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
            val decor = activity?.window?.decorView
            decor?.setSystemUiVisibility(View.SYSTEM_UI_FLAG_LIGHT_STATUS_BAR)
        }

        activity?.window?.statusBarColor =
            ResourcesCompat.getColor(resources, R.color.white, null)

        emailView = view.findViewById(R.id.edt_email)
        passwordView = view.findViewById(R.id.edt_password)

        singUp = view.findViewById(R.id.sing_up_2)
        singUp.setOnClickListener {
            findNavController().navigate(
                LoginFragmentDirections.actionLoginFragmentToSingUpFragment()
            )
        }

        login = view.findViewById(R.id.login_button)
        login.setOnClickListener {
//            findNavController().navigate(
//                LoginFragmentDirections.actionLoginFragmentToMainFragment()
//            )

            CoroutineScope(Dispatchers.IO).launch {
                val response = DiversightService.newInstance().login(
                    LoginRequest(
                        email = emailView.editText?.text.toString(),
                        password = passwordView.editText?.text.toString()
                    )
                )
                CoroutineScope(Dispatchers.Main).launch {
                    handleLogin(response)
                }
            }
        }
    }

    private fun handleLogin(response: Response<User>) {
        if (response.isSuccessful) {
            if((response.body()?.message != "Senha Incorreta") && (response.body()?.message != "Usuario Nao Encontrado")) {
                findNavController().navigate(
                    LoginFragmentDirections.actionLoginFragmentToMainFragment()
                )
            } else {

            }
        }
    }
}
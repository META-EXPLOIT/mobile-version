package br.com.metaexploit.diversight.ui

import android.os.Build
import android.os.Bundle
import android.view.View
import androidx.appcompat.widget.AppCompatTextView
import androidx.core.content.res.ResourcesCompat
import androidx.fragment.app.Fragment
import androidx.lifecycle.ViewModelProvider
import androidx.navigation.fragment.findNavController
import br.com.metaexploit.diversight.R
import br.com.metaexploit.diversight.presenter.LoginViewModel
import br.com.metaexploit.diversight.presenter.LoginViewModelFactory
import com.google.android.material.button.MaterialButton
import com.google.android.material.textfield.TextInputLayout

class LoginFragment : Fragment(R.layout.fragment_login) {

    private lateinit var singUp: AppCompatTextView
    private lateinit var login: MaterialButton

    private lateinit var edtEmail: TextInputLayout
    private lateinit var edtPassword: TextInputLayout

    private lateinit var viewModel: LoginViewModel

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
        super.onViewCreated(view, savedInstanceState)

        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
            val decor = activity?.window?.decorView
            decor?.setSystemUiVisibility(View.SYSTEM_UI_FLAG_LIGHT_STATUS_BAR)
        }

        activity?.window?.statusBarColor =
            ResourcesCompat.getColor(resources, R.color.white, null)

        edtEmail = view.findViewById(R.id.edt_email)
        edtPassword = view.findViewById(R.id.edt_password)
        login = view.findViewById(R.id.login_button)
        singUp = view.findViewById(R.id.sing_up_2)
        viewModel = ViewModelProvider(this, LoginViewModelFactory()).get(LoginViewModel::class.java)

        login.setOnClickListener {
            viewModel.login(
                edtEmail.editText?.text.toString(),
                edtPassword.editText?.text.toString()
            )
        }
        setObservers()

        singUp.setOnClickListener {
            findNavController().navigate(
                LoginFragmentDirections.actionLoginFragmentToSingUpFragment()
            )
        }
    }

    private fun setObservers() {
        viewModel.userLiveData.observe(viewLifecycleOwner, { user ->
            if ((user?.message != "Senha Incorreta") && (user?.message != "Usuario Nao Encontrado")) {
                findNavController().navigate(
                    LoginFragmentDirections.actionLoginFragmentToMainFragment()
                )
            }
        })
    }
}
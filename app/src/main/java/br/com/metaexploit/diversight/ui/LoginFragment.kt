package br.com.metaexploit.diversight.ui

import android.os.Build
import android.os.Bundle
import android.view.View
import android.widget.ProgressBar
import androidx.appcompat.widget.AppCompatTextView
import androidx.core.content.res.ResourcesCompat
import androidx.fragment.app.Fragment
import androidx.lifecycle.ViewModelProvider
import androidx.navigation.fragment.findNavController
import br.com.metaexploit.diversight.R
import br.com.metaexploit.diversight.presenter.login.LoginViewModel
import br.com.metaexploit.diversight.presenter.login.LoginViewModelFactory
import com.google.android.material.button.MaterialButton
import com.google.android.material.textfield.TextInputLayout

class LoginFragment : Fragment(R.layout.fragment_login) {

    private lateinit var singUp: AppCompatTextView
    private lateinit var login: MaterialButton

    private lateinit var edtEmail: TextInputLayout
    private lateinit var edtPassword: TextInputLayout
    private lateinit var errorLabel: AppCompatTextView

    private lateinit var background: View
    private lateinit var loading: ProgressBar

    private lateinit var viewModel: LoginViewModel

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
        super.onViewCreated(view, savedInstanceState)

        activity?.window?.statusBarColor =
            ResourcesCompat.getColor(resources, R.color.white, null)

//        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
//            @Suppress("DEPRECATION")
//            activity?.window?.decorView?.setSystemUiVisibility(View.SYSTEM_UI_FLAG_LIGHT_STATUS_BAR)
//        }

        errorLabel = view.findViewById(R.id.fg_login_label_error)
        edtEmail = view.findViewById(R.id.fg_login_edt_email)
        edtPassword = view.findViewById(R.id.fg_login_edt_password)
        login = view.findViewById(R.id.fg_login_login_button)
        singUp = view.findViewById(R.id.fg_login_sing_up_button)
        background = view.findViewById(R.id.fg_login_view_bc_loading)
        loading = view.findViewById(R.id.fg_login_progress_bar)
        viewModel = ViewModelProvider(this, LoginViewModelFactory()).get(LoginViewModel::class.java)

        login.setOnClickListener {
            setLoading(true)
            viewModel.login(
                edtEmail.editText?.text.toString(),
                edtPassword.editText?.text.toString()
            )
        }
        setObservers()

        singUp.setOnClickListener {
            findNavController().navigate(
                LoginFragmentDirections.actionLoginFragmentToSingUpPart1Fragment()
            )
        }
    }

    private fun setLoading(option: Boolean) {
        if (option) {
            loading.visibility = View.VISIBLE
            background.visibility = View.VISIBLE
        } else {
            loading.visibility = View.INVISIBLE
            background.visibility = View.INVISIBLE
        }
    }


    private fun setObservers() {
        viewModel.userLiveData.observe(viewLifecycleOwner, { user ->
            errorLabel.text = ""
            when (user?.message) {
                "Senha Incorreta" -> {
                    errorLabel.visibility = View.VISIBLE
                    errorLabel.text = "Senha incorreta"
                    setLoading(false)
                }
                "Usuario Nao Encontrado" -> {
                    errorLabel.visibility = View.VISIBLE
                    errorLabel.text = "Usuário não encontrado"
                    setLoading(false)
                }
                else -> {
                    errorLabel.visibility = View.INVISIBLE
                    setLoading(false)
                    findNavController().navigate(
                        LoginFragmentDirections.actionLoginFragmentToHomeFragment()
                    )
                }
            }
        })
    }
}